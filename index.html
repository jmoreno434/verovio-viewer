<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MusicXML/MXL → SVG + Instrumentos</title>

  <!-- Verovio WASM por CDN -->
  <script src="https://www.verovio.org/javascript/latest/verovio-toolkit-wasm.js" defer></script>

  <!-- Tone.js por CDN -->
  <script src="https://unpkg.com/tone@15.1.22/build/Tone.js"></script>

  <!-- Librería de instrumentos para Tone.js -->
  <script src="https://cdn.jsdelivr.net/gh/nbrosowsky/tonejs-instruments@master/Tonejs-Instruments.js"></script>

  <style>
    body { font-family: sans-serif; margin: 1rem; }
    #notation { border:1px solid #ddd; padding:1rem; min-height:200px; }
    .controls { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom:1rem; }
    button, input, select { padding:0.4rem 0.8rem; }
  </style>
</head>
<body>
  <h1>Visor + Reproductor de MusicXML</h1>
  <div class="controls">
    <input id="fileInput" type="file" accept=".xml,.musicxml,.mxl" />
    <button id="renderBtn" disabled>Renderizar</button>
    <select id="instrumentSelect">
      <option value="piano">Piano</option>
      <option value="guitar-electric">Guitarra Eléctrica</option>
    </select>
    <button id="loadInstBtn" disabled>Cargar Instrumento</button>
    <button id="playBtn" disabled>Reproducir</button>
    <button id="stopBtn" disabled>Detener</button>
  </div>
  <div id="notation"></div>

  <script>
    const $ = id => document.getElementById(id);
    let toolkit, dataBuffer, isZip = false;
    let instrumentObj = null, synthFallback = null;

    // Inicializar Verovio
    document.addEventListener('DOMContentLoaded', () => {
      verovio.module.onRuntimeInitialized = () => {
        toolkit = new verovio.toolkit();
        ['renderBtn','loadInstBtn','playBtn','stopBtn'].forEach(id => $(id).disabled = false);
        synthFallback = new Tone.Synth().toDestination();
      };
    });

    // Leer archivo
    $('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      isZip = /\.mxl$/i.test(file.name);
      const reader = new FileReader();
      reader.onload = () => dataBuffer = reader.result;
      if (isZip) reader.readAsArrayBuffer(file);
      else reader.readAsText(file);
    });

    // Renderizar SVG
    $('renderBtn').addEventListener('click', () => {
      if (!dataBuffer) return;
      toolkit.setOptions({ scale: 60 });
      if (isZip) {
        toolkit.loadZipDataBuffer(new Uint8Array(dataBuffer), dataBuffer.byteLength);
      } else {
        toolkit.loadData(dataBuffer);
      }
      $('notation').innerHTML = toolkit.renderToSVG(1);
    });

    // Cargar instrumento
    $('loadInstBtn').addEventListener('click', () => {
      const inst = $('instrumentSelect').value;
      instrumentObj = SampleLibrary.load({
        instruments: inst,
        baseUrl: 'https://nbrosowsky.github.io/tonejs-instruments/samples/'
      });
      instrumentObj.toDestination();
    });

    // Programar reproducción
    Tone.Transport.bpm.value = 120;
    function schedulePlayback(xmlString) {
      const xmlDoc = new DOMParser().parseFromString(xmlString, "application/xml");
      const divisions = parseFloat(xmlDoc.querySelector("divisions")?.textContent || "1");
      let time = 0;
      xmlDoc.querySelectorAll("note").forEach(noteEl => {
        if (noteEl.querySelector("rest")) return;
        const step = noteEl.querySelector("step")?.textContent || "C";
        const alter = noteEl.querySelector("alter")?.textContent || "0";
        const octave = noteEl.querySelector("octave")?.textContent || "4";
        const accidental = alter === "1" ? "#" : alter === "-1" ? "b" : "";
        const pitch = `${step}${accidental}${octave}`;
        const durDivs = parseFloat(noteEl.querySelector("duration")?.textContent || divisions);
        const ratio = durDivs / divisions;
        const durVal = ratio >= 1 ? "4n" : ratio >= 0.5 ? "8n" : ratio >= 0.25 ? "16n" : "32n";

        Tone.Transport.schedule((t) => {
          const player = instrumentObj || synthFallback;
          player.triggerAttackRelease(pitch, durVal, t);
        }, time);

        time += ratio;
      });
    }

    // Reproducir y detener
    $('playBtn').addEventListener('click', async () => {
      if (!dataBuffer) return;
      await Tone.start();
      schedulePlayback(dataBuffer);
      Tone.Transport.start();
    });
    $('stopBtn').addEventListener('click', () => {
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
    });
  </script>
</body>
</html>
