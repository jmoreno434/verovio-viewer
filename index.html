<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MusicXML → SVG con Verovio (subida de archivo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Verovio toolkit (JS + WASM en el mismo /dist de la versión) -->
  <script src="https://cdn.jsdelivr.net/npm/verovio@5.4.0/dist/verovio-toolkit-wasm.js" defer></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f6f6f6; }
    header { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    #out { background: #fff; border: 1px solid #ddd; min-height: 240px; padding: 8px; }
    .status { font-size: 14px; color: #555; min-height: 1.2em; margin-left: 8px; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <header>
    <label>Archivo (MusicXML/MXL):
      <input id="file" type="file" accept=".xml,.musicxml,.mxl" />
    </label>
    <button id="btn">Convertir a SVG</button>
    <button id="demo">Cargar demo</button>
    <span id="status" class="status">Inicializando Verovio…</span>
  </header>

  <div id="out">Aquí aparecerá el SVG</div>

  <script>
    // 1) Esperar a que WASM esté listo y crear el toolkit (patrón recomendado)
    //    https://book.verovio.org/first-steps/getting-started.html
    let tk = null;
    const tkReady = new Promise((resolve) => {
      verovio.module.onRuntimeInitialized = () => {
        tk = new verovio.toolkit({
          pageWidth: 2100,   // tamaño "A4" aprox. (en decimales de mm internos de Verovio)
          pageHeight: 2970,
          scale: 40          // zoom (ajústalo a tu gusto)
        });
        document.getElementById('status').textContent = 'Listo. Sube tu MusicXML/MXL o usa la demo.';
        resolve();
      };
    });

    // 2) Utilidades para convertir
    function renderToPage(page = 1) {
      const svg = tk.renderToSVG(page, {});  // SVG como string
      document.getElementById('out').innerHTML = svg;
    }

    async function fromMusicXMLText(xmlText) {
      tk.loadData(xmlText);                  // carga MusicXML en texto
      renderToPage(1);
    }

    async function fromMXLBuffer(arrayBuffer) {
      const bytes = new Uint8Array(arrayBuffer);
      // Carga MXL (MusicXML comprimido) y renderiza
      tk.loadZipDataBuffer(bytes, bytes.length);
      renderToPage(1);
    }

    // 3) Interacción: botón "Convertir a SVG"
    document.getElementById('btn').addEventListener('click', async () => {
      const f = document.getElementById('file').files?.[0];
      if (!f) return (document.getElementById('status').textContent = 'Selecciona un archivo primero.');
      document.getElementById('status').textContent = 'Convirtiendo…';
      await tkReady;
      try {
        if (f.name.toLowerCase().endsWith('.mxl')) {
          await fromMXLBuffer(await f.arrayBuffer());
        } else {
          await fromMusicXMLText(await f.text());
        }
        document.getElementById('status').textContent = 'SVG generado ✔';
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = 'Error al convertir: ' + (e?.message || e);
      }
    });

    // 4) Pequeña demo embebida (MusicXML)
    const DEMO_XML = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <part-list><score-part id="P1"><part-name>Demo</part-name></score-part></part-list>
  <part id="P1">
    <measure number="1">
      <attributes>
        <divisions>1</divisions>
        <key><fifths>0</fifths></key>
        <time><beats>4</beats><beat-type>4</beat-type></time>
        <clef><sign>G</sign><line>2</line></clef>
      </attributes>
      <note><pitch><step>C</step><octave>4</octave></pitch><duration>1</duration><type>quarter</type></note>
      <note><pitch><step>D</step><octave>4</octave></pitch><duration>1</duration><type>quarter</type></note>
      <note><pitch><step>E</step><octave>4</octave></pitch><duration>1</duration><type>quarter</type></note>
      <note><rest/><duration>1</duration><type>quarter</type></note>
      <barline location="right"><bar-style>light-heavy</bar-style></barline>
    </measure>
  </part>
</score-partwise>`;

    document.getElementById('demo').addEventListener('click', async () => {
      await tkReady;
      document.getElementById('status').textContent = 'Generando demo…';
      try {
        await fromMusicXMLText(DEMO_XML);
        document.getElementById('status').textContent = 'SVG demo ✔';
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = 'Error demo: ' + (e?.message || e);
      }
    });
  </script>
</body>
</html>
