<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MusicXML → SVG + Player Completo</title>

  <!-- 1) Verovio WASM -->
  <script src="https://www.verovio.org/javascript/latest/verovio-toolkit-wasm.js" defer></script>

  <!-- 2) Tone.js -->
  <script src="https://unpkg.com/tone@15.1.22/build/Tone.js"></script>

  <!-- 3) soundfont-player UMD (0.12.0) -->
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.js"></script>

  <link rel="icon" href="data:," />
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; margin-bottom:.6rem; }
    button, input, select { padding:.4rem .6rem; }
    #notation { border:1px solid #ddd; padding:1rem; min-height:260px; }

    /* Nota en reproducción */
    g.note.playing, g.note.playing * {
      fill: red !important;
      stroke: red !important;
    }
    /* Compás actual */
    g.measure.current-measure, g.measure.current-measure * {
      stroke: orange !important;
      stroke-width: 1.5 !important;
    }
  </style>
</head>
<body>
  <h1>MusicXML → SVG + Player Avanzado</h1>

  <!-- Carga y render -->
  <div class="row">
    <input id="fileInput" type="file" accept=".xml,.musicxml,.mxl" />
    <button id="renderBtn" disabled>Renderizar</button>
    <span id="info"></span>
  </div>

  <!-- Paginación & escala -->
  <div class="row">
    <button id="prevBtn" disabled>← Anterior</button>
    <span>Página <span id="pageNow">1</span>/<span id="pageMax">1</span></span>
    <button id="nextBtn" disabled>Siguiente →</button>
    <label>Escala (%) <input id="scaleInput" type="number" min="30" max="200" step="5" value="60"></label>
    <button id="applyScale" disabled>Aplicar</button>
  </div>

  <!-- Instrumento -->
  <div class="row">
    <label>Instrumento
      <select id="instrumentSelect">
        <option value="acoustic_grand_piano" selected>Piano</option>
        <option value="violin">Violín</option>
        <option value="cello">Cello</option>
        <option value="flute">Flauta</option>
        <option value="trumpet">Trompeta</option>
        <option value="tenor_sax">Saxo tenor</option>
        <option value="acoustic_guitar_nylon">Guitarra clásica</option>
        <option value="electric_guitar_clean">Guitarra eléctrica</option>
      </select>
    </label>
    <button id="loadInstBtn" disabled>Cargar instrumento</button>
    <span id="instInfo"></span>
  </div>

  <!-- Controles de reproducción -->
  <fieldset class="row">
    <legend>Reproducción</legend>
    <button id="playBtn" disabled>▶ Reproducir</button>
    <button id="stopBtn" disabled>■ Detener</button>

    <label>Tempo (♩=)
      <input id="tempoRange" type="range" min="40" max="200" step="1" value="120">
      <span id="tempoVal">120</span>
    </label>

    <label>Loop barras:
      <input id="loopStart" type="number" min="1" value="1" style="width:4rem"> –
      <input id="loopEnd"   type="number" min="1" value="4" style="width:4rem">
    </label>
    <button id="applyLoop" disabled>Aplicar bucle</button>
    <button id="clearLoop" disabled>Quitar bucle</button>

    <span id="meterNow"></span>
  </fieldset>

  <!-- Mezcla por voces -->
  <fieldset>
    <legend>Mezcla por voces (staves)</legend>
    <div id="mixer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.5rem;"></div>
  </fieldset>

  <!-- Contenedor SVG -->
  <div id="notation"></div>

  <script>
  (function(){
    const $ = id => document.getElementById(id);

    let toolkit, dataBuf, isZip=false;
    let currentPage=1, totalPages=1;
    let timemap=[], measureStarts=[], baseTempo=120, tempoNow=120;

    // SoundFont
    let sf = null;

    // Mezcla
    let staffGain={}, staffMute={}, staffSolo=null;

    // -------- Inicializar Verovio --------
    document.addEventListener('DOMContentLoaded', () => {
      verovio.module.onRuntimeInitialized = () => {
        toolkit = new verovio.toolkit();
        ['renderBtn','applyScale','loadInstBtn','playBtn','stopBtn','applyLoop','clearLoop']
          .forEach(id => $(id).disabled = false);
      };
    });

    // -------- Cargar archivo --------
    $('fileInput').addEventListener('change', e => {
      const f = e.target.files[0]; if (!f) return;
      isZip = /\.mxl$/i.test(f.name);
      $('info').textContent = f.name;
      const reader = new FileReader();
      reader.onload = () => dataBuf = reader.result;
      isZip ? reader.readAsArrayBuffer(f) : reader.readAsText(f);
    });

    // -------- Renderizar y extraer timemap --------
    function applyOptions() {
      toolkit.setOptions({
        pageWidth: 2000,
        pageHeight: 2600,
        scale: parseInt($('scaleInput').value, 10)
      });
    }

    $('renderBtn').onclick = () => {
      if (!dataBuf) return;
      applyOptions();
      if (isZip) {
        toolkit.loadZipDataBuffer(new Uint8Array(dataBuf), dataBuf.byteLength);
      } else {
        toolkit.loadData(dataBuf);
      }
      totalPages = toolkit.getPageCount();
      currentPage = 1;
      $('pageMax').textContent = totalPages;
      $('notation').innerHTML = toolkit.renderToSVG(currentPage);
      $('pageNow').textContent = currentPage;

      // Generar timemap (objeto JS o string)
      let tmRaw = toolkit.renderToTimemap({ includeMeasures: true });
      timemap = (typeof tmRaw === 'string') ? JSON.parse(tmRaw) : tmRaw;

      // Detectar tempo base
      const tEvt = timemap.find(e => e.tempo !== undefined);
      baseTempo = tEvt ? Number(tEvt.tempo) : 120;
      tempoNow = baseTempo;
      $('tempoRange').value = tempoNow;
      $('tempoVal').textContent = tempoNow;

      // Extraer inicios de compás
      measureStarts = [];
      let lastQ = -1, idx = 1;
      timemap.forEach(e => {
        if (typeof e.qstamp === 'number') {
          const q = e.qstamp;
          if (Math.abs(q - Math.round(q)) < 1e-6 && q > lastQ) {
            measureStarts[idx++] = (e.tstamp || 0) / 1000;
            lastQ = q;
          }
        }
      });

      // Cargar MIDI interno
      toolkit.renderToMIDI();
    };

    $('prevBtn').onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        $('notation').innerHTML = toolkit.renderToSVG(currentPage);
        $('pageNow').textContent = currentPage;
      }
    };
    $('nextBtn').onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        $('notation').innerHTML = toolkit.renderToSVG(currentPage);
        $('pageNow').textContent = currentPage;
      }
    };
    $('applyScale').onclick = () => {
      applyOptions();
      $('notation').innerHTML = toolkit.renderToSVG(currentPage);
    };

    // -------- Cargar instrumento --------
    $('loadInstBtn').onclick = async () => {
      await Tone.start(); // user gesture to unlock audio
      $('instInfo').textContent = 'Cargando…';
      try {
        sf = await Soundfont.instrument(Tone.context.rawContext, $('instrumentSelect').value);
        $('instInfo').textContent = 'Instrumento listo';
      } catch (err) {
        console.error(err);
        $('instInfo').textContent = 'Error cargando instrumento';
      }
    };

    // -------- Mixer UI --------
    function buildMixer(staves) {
      const mix = $('mixer');
      mix.innerHTML = '';
      const unique = [...new Set(staves)].sort((a,b)=>a-b);
      const list = unique.length ? unique : [1,2,3,4];
      list.forEach(st => {
        if (!(st in staffGain)) staffGain[st] = 1;
        const ch = document.createElement('div');
        ch.style.border='1px solid #eee'; ch.style.padding='.5rem'; ch.style.borderRadius='.4rem';
        ch.innerHTML = `
          <strong>Staff ${st}</strong><br>
          Vol <input type="range" min="0" max="1" step="0.01" value="${staffGain[st]}" data-st="${st}" class="vol"><br>
          <button class="solo" data-st="${st}">${staffSolo===st?'Unsolo':'Solo'}</button>
          <button class="mute" data-st="${st}">${staffMute[st]?'Unmute':'Mute'}</button>
        `;
        mix.appendChild(ch);
      });
      mix.querySelectorAll('.vol').forEach(r=>r.oninput=e=>{
        staffGain[+e.target.dataset.st] = +e.target.value;
      });
      mix.querySelectorAll('.mute').forEach(b=>b.onclick=e=>{
        const s=+e.target.dataset.st; staffMute[s]=!staffMute[s]; buildMixer(list);
      });
      mix.querySelectorAll('.solo').forEach(b=>b.onclick=e=>{
        const s=+e.target.dataset.st; staffSolo = (staffSolo===s?null:s); buildMixer(list);
      });
    }

    // -------- Limpieza visual --------
    function clearVisual() {
      document.querySelectorAll('g.note.playing').forEach(n=>n.classList.remove('playing'));
      document.querySelectorAll('g.measure.current-measure').forEach(m=>m.classList.remove('current-measure'));
    }

    // -------- Programación y seguimiento --------
    function scheduleAll() {
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      Tone.Transport.position = 0;
      clearVisual();

      // Cache pitch/staff
      const cache = new Map();
      const staves = new Set();
      function infoFor(id) {
        if (cache.has(id)) return cache.get(id);
        let midi = 60, staff = 1;
        try {
          const mv = toolkit.getMIDIValuesForElement(id);
          const mj = (typeof mv==='string') ? JSON.parse(mv) : mv;
          if (Number.isFinite(mj.midi)) midi = mj.midi;
        } catch {}
        try {
          const at = toolkit.getElementAttr(id);
          const aj = (typeof at==='string') ? JSON.parse(at) : at;
          if (Number.isFinite(+aj.staff)) staff = +aj.staff;
        } catch {}
        staves.add(staff);
        const out = { midi, staff };
        cache.set(id, out);
        return out;
      }
      buildMixer([...staves]);

      // Visual polling
      Tone.Transport.scheduleRepeat(()=>{
        const factor = baseTempo / tempoNow;
        const realSec = Tone.Transport.seconds;
        const scoreMs = realSec * 1000 * factor;
        let els = toolkit.getElementsAtTime(Math.floor(scoreMs));
        if (typeof els==='string') els = JSON.parse(els);
        if (!els || !els.page) return;
        if (els.page !== currentPage) {
          currentPage = els.page;
          $('notation').innerHTML = toolkit.renderToSVG(currentPage);
          $('pageNow').textContent = currentPage;
        }
        clearVisual();
        (els.notes||[]).forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.classList.add('playing');
        });
        let cm=1, sec=scoreMs/1000;
        for (let i=1; i<measureStarts.length; i++){
          if (sec>=measureStarts[i]) cm=i; else break;
        }
        $('meterNow').textContent = `Compás: ${cm}`;
        const meas = document.querySelector(`#notation g.measure[id*="${cm}"]`);
        if (meas) meas.classList.add('current-measure');
      }, 0.05);

      // Audio events
      const factor = baseTempo / tempoNow;
      for (const ev of timemap) {
        if (!ev.on?.length) continue;
        const when = (ev.tstamp||0)/1000 * factor;
        Tone.Transport.schedule((time)=>{
          ev.on.forEach(id=>{
            const { midi, staff } = infoFor(id);
            // compute off time:
            const offEvt = timemap.find(x=>x.off?.includes(id));
            const durBase = offEvt ? ((offEvt.tstamp - ev.tstamp)/1000) : 0.25;
            const durReal = durBase * factor;
            let vel = staffGain[staff] ?? 1;
            if (staffSolo!==null && staff!==staffSolo) vel*=0.2;
            if (staffMute[staff]) vel=0;
            if (vel<=0) return;
            const noteName = Tone.Frequency(midi,"midi").toNote();
            if (sf) {
              sf.play(noteName, time, { duration: durReal, gain: vel });
            } else {
              const synth = new Tone.Synth().toDestination();
              synth.triggerAttackRelease(noteName, durReal, time, vel);
            }
          });
        }, when);
      }
    }

    // -------- Play / Stop --------
    $('playBtn').onclick = async ()=>{
      if (!dataBuf || isZip) return alert("Carga un .xml/.musicxml para audio.");
      await Tone.start();
      tempoNow = +$('tempoRange').value;
      $('tempoVal').textContent = tempoNow;
      scheduleAll();
      Tone.Transport.start();
    };
    $('stopBtn').onclick = ()=>{
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      Tone.Transport.position = 0;
      clearVisual();
    };

    // -------- Tempo slider --------
    $('tempoRange').oninput = e=>{
      $('tempoVal').textContent = e.target.value;
      if (Tone.Transport.state==='started') {
        tempoNow = +e.target.value;
        scheduleAll();
        Tone.Transport.start();
      }
    };

    // -------- Loop compases --------
    function secAtBar(n){
      return (measureStarts[n] || 0) * (baseTempo/tempoNow);
    }
    $('applyLoop').onclick = ()=>{
      const a = +$('loopStart').value, b = +$('loopEnd').value;
      Tone.Transport.setLoopPoints(secAtBar(a), secAtBar(b));
      Tone.Transport.loop = true;
    };
    $('clearLoop').onclick = ()=>{
      Tone.Transport.loop = false;
      Tone.Transport.setLoopPoints(0,0);
    };
  })();
  </script>
</body>
</html>
