<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MusicXML/MXL → SVG con Verovio + Reproductor</title>

  <!-- Verovio WASM -->
  <script src="https://www.verovio.org/javascript/latest/verovio-toolkit-wasm.js" defer></script>
  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@15.1.22/build/Tone.js"></script>
  <!-- Evitar 404 de favicon en dev -->
  <link rel="icon" href="data:," />

  <style>
    body { font-family: sans-serif; margin: 1rem; }
    #notation { border: 1px solid #ddd; padding: 1rem; min-height:200px; }
    .controls { display:flex; align-items:center; gap:1rem; flex-wrap:wrap; margin-top:0.5rem; }
    button, input { padding:0.4rem 0.8rem; }
  </style>
</head>
<body>
  <h1>Convertir MusicXML/MXL → SVG + Reproductor</h1>

  <!-- Selección de archivo y render -->
  <div class="controls">
    <input id="fileInput" type="file" accept=".xml,.musicxml,.mxl" />
    <button id="renderBtn" disabled>Renderizar</button>
    <span id="info"></span>
  </div>

  <!-- Paginación -->
  <div class="controls">
    <button id="prevBtn" disabled>← Anterior</button>
    <span>Página <span id="pageNow">1</span> / <span id="pageMax">1</span></span>
    <button id="nextBtn" disabled>Siguiente →</button>
  </div>

  <!-- Escala -->
  <div class="controls">
    <label for="scaleInput">Escala (%)</label>
    <input id="scaleInput" type="number" value="60" min="10" max="200" step="5" />
    <button id="applyScale" disabled>Aplicar</button>
  </div>

  <!-- Reproducción -->
  <div class="controls">
    <button id="playBtn" disabled>Reproducir</button>
    <button id="stopBtn" disabled>Detener</button>
  </div>

  <!-- Contenedor SVG -->
  <div id="notation"></div>

  <script>
    const $ = id => document.getElementById(id);

    let toolkit,           // Verovio
        dataBuffer,        // MusicXML (string) o MXL (ArrayBuffer)
        isZip = false,
        currentPage = 1,
        totalPages = 1;

    // Sampler global (piano); fallback synth por si faltara
    let sampler = null;
    const fallbackSynth = new Tone.Synth().toDestination();

    // 1) Inicializar Verovio
    document.addEventListener('DOMContentLoaded', () => {
      verovio.module.onRuntimeInitialized = () => {
        toolkit = new verovio.toolkit();
        ['renderBtn','applyScale','playBtn','stopBtn']
          .forEach(id => $(id).disabled = false);
      };
    });

    // 2) Lectura del archivo seleccionado
    $('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      isZip = /\.mxl$/i.test(file.name);
      $('info').textContent = `Archivo: ${file.name}`;
      const reader = new FileReader();
      reader.onload = () => { dataBuffer = reader.result; };
      isZip ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
    });

    // 3) Opciones de layout/escala
    function applyOptions() {
      toolkit.setOptions({
        pageWidth: 2000,
        pageHeight:2600,
        scale: parseInt($('scaleInput').value, 10)
      });
    }

    // 4) Render inicial (XML o MXL)
    function renderInitial() {
      if (!dataBuffer) return;
      applyOptions();

      if (isZip) {
        toolkit.loadZipDataBuffer(new Uint8Array(dataBuffer), dataBuffer.byteLength);
      } else {
        toolkit.loadData(dataBuffer);
      }

      totalPages = toolkit.getPageCount();
      currentPage = 1;
      $('pageMax').textContent = totalPages;
      $('prevBtn').disabled = totalPages <= 1;
      $('nextBtn').disabled = totalPages <= 1;

      $('notation').innerHTML = toolkit.renderToSVG(currentPage);
      $('pageNow').textContent = currentPage;
    }

    // 5) Navegación de páginas
    function renderPage(page) {
      if (page < 1 || page > totalPages) return;
      $('notation').innerHTML = toolkit.renderToSVG(page);
      currentPage = page;
      $('pageNow').textContent = currentPage;
    }

    // 6) Enlaces a botones de render/paginación
    $('renderBtn').onclick  = renderInitial;
    $('prevBtn').onclick    = () => renderPage(currentPage - 1);
    $('nextBtn').onclick    = () => renderPage(currentPage + 1);
    $('applyScale').onclick = () => { applyOptions(); renderPage(currentPage); };

    // 7) Sampler de piano (Salamander). Se carga bajo demanda.
    function ensureSampler() {
      if (sampler) return sampler;
      sampler = new Tone.Sampler({
        urls: {
          "C4":  "C4.mp3",
          "D#4": "Ds4.mp3",
          "F#4": "Fs4.mp3",
          "A4":  "A4.mp3",
          "C5":  "C5.mp3"
        },
        release: 1,
        baseUrl: "https://tonejs.github.io/audio/salamander/"
      }).toDestination();
      return sampler;
    }

    // 8) Programar reproducción (a partir de MusicXML texto)
    Tone.Transport.bpm.value = 120;

    function schedulePlayback(xmlString) {
      // Limpieza por si el usuario pulsó Play varias veces
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      Tone.Transport.position = 0;

      const xmlDoc = new DOMParser().parseFromString(xmlString, "application/xml");
      const divisions = parseFloat(xmlDoc.querySelector("divisions")?.textContent || "1");

      let timeSec = 0; // acumulador en segundos

      xmlDoc.querySelectorAll("note").forEach(noteEl => {
        if (noteEl.querySelector("rest")) return;

        const step   = noteEl.querySelector("step")?.textContent   || "C";
        const alter  = noteEl.querySelector("alter")?.textContent  || "0";
        const octave = noteEl.querySelector("octave")?.textContent || "4";
        const acc    = alter === "1" ? "#" : (alter === "-1" ? "b" : "");
        const pitch  = `${step}${acc}${octave}`;

        const durDivs = parseFloat(noteEl.querySelector("duration")?.textContent || divisions);
        const ratio   = durDivs / divisions; // fracción de negra
        const durVal  = ratio >= 1    ? "4n"
                        : ratio >= 0.5 ? "8n"
                        : ratio >= 0.25? "16n"
                                        : "32n";

        // Programar a 'timeSec' (segundos) y convertir la duración musical a segundos
        Tone.Transport.schedule(t => {
          const player = sampler || fallbackSynth;
          player.triggerAttackRelease(pitch, durVal, t);
        }, timeSec);

        // Avanzar el cursor en segundos según el valor musical
        timeSec += Tone.Time(durVal).toSeconds();
      });
    }

    // 9) Reproducir / Detener
    $('playBtn').onclick = async () => {
      if (!dataBuffer) return;
      if (isZip) { alert("Para reproducir usa un .xml/.musicxml (no .mxl)"); return; }

      await Tone.start();     // requisito de autoplay: gesto del usuario
      ensureSampler();        // crear/cargar sampler si hace falta
      await Tone.loaded();    // esperar a que TODAS las muestras estén listas

      schedulePlayback(dataBuffer);
      Tone.Transport.start();
    };

    $('stopBtn').onclick = () => {
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      Tone.Transport.position = 0;
    };
  </script>
</body>
</html>
